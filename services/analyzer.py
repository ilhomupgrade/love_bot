"""
AI-–∞–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
"""

from openai import AsyncOpenAI
from config import OPENAI_API_KEY

client = AsyncOpenAI(api_key=OPENAI_API_KEY)


async def analyze(answers1: list, answers2: list) -> tuple[int, str]:
    """
    –ê–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤ –¥–≤—É—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤

    Args:
        answers1: —Å–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç–æ–≤ –ø–µ—Ä–≤–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
        answers2: —Å–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç–æ–≤ –≤—Ç–æ—Ä–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞

    Returns:
        tuple: (compatibility_score, full_report)
    """
    # –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–ø—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤)
    same = sum(1 for a, b in zip(answers1, answers2) if a == b)
    score = int(same / len(answers1) * 100) if answers1 else 0

    # –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ–ª–∏
    system_message = """–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥-—ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º —Å 15-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–∞–º–∏.
–¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞ —Ç–µ–æ—Ä–∏–∏ —è–∑—ã–∫–æ–≤ –ª—é–±–≤–∏ –ì—ç—Ä–∏ –ß–µ–ø–º–µ–Ω–∞ –∏ –≥–ª—É–±–æ–∫–æ –ø–æ–Ω–∏–º–∞–µ—à—å –¥–∏–Ω–∞–º–∏–∫—É –æ—Ç–Ω–æ—à–µ–Ω–∏–π.

–¢–≤–æ–π —Å—Ç–∏–ª—å –∞–Ω–∞–ª–∏–∑–∞:
- –ì–ª—É–±–æ–∫–∏–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã, –∞ –Ω–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –¢—ë–ø–ª—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, –Ω–æ —á–µ—Å—Ç–Ω—ã–π —Ç–æ–Ω
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—à—å –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º—ã, –Ω–æ –∏ —Å–∫—Ä—ã—Ç—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–∞—Ä—ã

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –ø–∞—Ä–∞–º –Ω–µ –ø—Ä–æ—Å—Ç–æ –∞–Ω–∞–ª–∏–∑, –∞ –Ω–∞—Å—Ç–æ—è—â–µ–µ –æ–∑–∞—Ä–µ–Ω–∏–µ –æ –∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö."""

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
    user_prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã –¥–≤—É—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —è–∑—ã–∫–∞—Ö –ª—é–±–≤–∏ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

–ö–û–ù–¢–ï–ö–°–¢ –í–û–ü–†–û–°–û–í:
–í–æ–ø—Ä–æ—Å 1-5 –∫–∞—Å–∞—é—Ç—Å—è –ø—è—Ç–∏ —è–∑—ã–∫–æ–≤ –ª—é–±–≤–∏:
A) –í—Ä–µ–º—è –≤–º–µ—Å—Ç–µ (Quality Time)
B) –ü–æ–¥–∞—Ä–∫–∏ (Gifts)
C) –°–ª–æ–≤–∞ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è (Words of Affirmation)
D) –ü–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (Acts of Service)
E) –ü—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏—è (Physical Touch)

–û–¢–í–ï–¢–´:
–ü–∞—Ä—Ç–Ω—ë—Ä 1: {answers1}
–ü–∞—Ä—Ç–Ω—ë—Ä 2: {answers2}

–°–¢–†–£–ö–¢–£–†–ê –ê–ù–ê–õ–ò–ó–ê:

1. **–ò–Ω–¥–µ–∫—Å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: {score}%**
   - –û–±—ä—è—Å–Ω–∏, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç
   - –†–∞—Å–∫—Ä–æ–π –≥–ª—É–±–∏–Ω–Ω—ã–π —Å–º—ã—Å–ª —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –∏ —Ä–∞–∑–ª–∏—á–∏–π
   - –î–∞–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –∏–Ω—Å–∞–π—Ç –æ —Ç–æ–º, —á—Ç–æ —Ü–∏—Ñ—Ä—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç

2. **–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç —è–∑—ã–∫–æ–≤ –ª—é–±–≤–∏**:
   - –û–ø—Ä–µ–¥–µ–ª–∏ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —è–∑—ã–∫ –ª—é–±–≤–∏ –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
   - –û–±—ä—è—Å–Ω–∏, —á—Ç–æ —ç—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –∏—Ö –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –∏—Å—Ç–æ—Ä–∏–∏
   - –ü–æ–∫–∞–∂–∏, –∫–∞–∫ –∏—Ö —è–∑—ã–∫–∏ –ª—é–±–≤–∏ –¥–æ–ø–æ–ª–Ω—è—é—Ç –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É
   - –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è —ç—Ç–∏—Ö —è–∑—ã–∫–æ–≤ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö

3. **–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã**:
   - –£–∫–∞–∂–∏ 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏, –≥–¥–µ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏—è
   - –û–±—ä—è—Å–Ω–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞: –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ —Ä–∞–∑–ª–∏—á–∏—è –≤–∞–∂–Ω—ã
   - –ü–æ–∫–∞–∂–∏ —Å–∫—Ä—ã—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–æ—Å—Ç–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π
   - –î–∞–π –∏–Ω—Å–∞–π—Ç –æ —Ç–æ–º, –∫–∞–∫ —Ä–∞–∑–ª–∏—á–∏—è –º–æ–≥—É—Ç —Å—Ç–∞—Ç—å —Å–∏–ª–æ–π

4. **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
   - –î–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞ 1: 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
   - –î–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞ 2: 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
   - –û–±—â–∏–µ –¥–ª—è –ø–∞—Ä—ã: 2 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–ª–∏ —Ä–∏—Ç—É–∞–ª–∞
   - "–ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞": —á—Ç–æ –¥–µ–ª–∞—Ç—å –≤ –æ—Å—Ç—Ä—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö

5. **–û–±—Ä–∞–∑ –≤–∞—à–µ–π –ø–∞—Ä—ã**:
   - –°–æ–∑–¥–∞–π —è—Ä–∫—É—é, –∑–∞–ø–æ–º–∏–Ω–∞—é—â—É—é—Å—è –º–µ—Ç–∞—Ñ–æ—Ä—É
   - –û–ø–∏—à–∏ –∏—Ö —É–Ω–∏–∫–∞–ª—å–Ω—É—é –¥–∏–Ω–∞–º–∏–∫—É
   - –ü–æ–∫–∞–∂–∏ –∏—Ö –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —á–µ—Ä–µ–∑ 5-10 –ª–µ—Ç
   - –ó–∞–≤–µ—Ä—à–∞—é—â–∏–π –∏–Ω—Å–∞–π—Ç, –∫–æ—Ç–æ—Ä—ã–π –¥–∞—Å—Ç –Ω–∞–¥–µ–∂–¥—É –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ü–∏—à–∏ –∂–∏–≤—ã–º —è–∑—ã–∫–æ–º, –∏–∑–±–µ–≥–∞–π –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞
- –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É: –∏–º–µ–Ω–∞, —Å–∏—Ç—É–∞—Ü–∏–∏, –ø—Ä–∏–º–µ—Ä—ã
- –ë—É–¥—å —á–µ—Å—Ç–Ω—ã–º, –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º
- –ö–∞–∂–¥–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω–∏–º–∞ —É–∂–µ —Å–µ–≥–æ–¥–Ω—è
- –ù–∞–π–¥–∏ —á—Ç–æ-—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –≤ —ç—Ç–æ–π –ø–∞—Ä–µ"""

    try:
        response = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_message},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.8,
            max_completion_tokens=2500
        )

        full_report = response.choices[0].message.content
        return score, full_report

    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        print(f"‚ùå –û—à–∏–±–∫–∞ OpenAI API: {e}")

        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—ã–π –æ—Ç—á—ë—Ç
        fallback_report = f"""
‚ù§Ô∏è **–ò–Ω–¥–µ–∫—Å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏**: {score}%

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç.
–í–∞—à –±–∞–∑–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: {score}%

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —É –≤–∞—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç {same} –∏–∑ {len(answers1)} –æ—Ç–≤–µ—Ç–æ–≤.
"""
        return score, fallback_report


def get_free_preview(full_report: str, limit: int = 500) -> str:
    """
    –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–µ–≤—å—é –æ—Ç—á—ë—Ç–∞

    Args:
        full_report: –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç
        limit: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø—Ä–µ–≤—å—é

    Returns:
        str: —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –æ—Ç—á—ë—Ç–∞
    """
    if len(full_report) <= limit:
        return full_report

    preview = full_report[:limit].rsplit('\n', 1)[0]  # –æ–±—Ä–µ–∑–∞–µ–º –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–µ
    preview += "\n\n...\n\nüíé **–ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø–ª–∞—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏**"

    return preview
